<div class="content-header">
    <div class="container-fluid">
        <h1>Data Penetration Testing</h1>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- Modal Update -->
    <div class="modal fade" id="modalEdit" data-backdrop="static" tabindex="-1" role="dialog"
        aria-labelledby="modalEditLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="modalEditLabel">Edit Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="errorAlert" class="alert alert-danger d-none"></div>
                    <div id="successAlert" class="alert alert-success d-none"></div>
                    <!-- Formulir pengeditan data -->
                    <form method="post" id="editForm" enctype="multipart/form-data"
                        action="<?= base_url('tabelpentest/update') ?>" onsubmit="tombolUpdate(event)">
                        <input type="hidden" name="id" id="editId">

                        <!-- Tambahkan input sesuai dengan field yang ada pada data -->
                        <div class="row">
                            <div class="form-group col-6">
                                <label for="idPentest">Id Pentest</label>
                                <input type="text" class="form-control" name="kd_pentest" id="editIdPentest"
                                    placeholder="Masukan Id Pentest">
                            </div>
                            <div class="form-group col-6">
                                <label for="pemohon">Pemohon</label>
                                <input type="text" class="form-control" name="pemohon" id="editPemohon"
                                    placeholder="Nama Pemohon">
                            </div>
                            <div class="form-group col-6">
                                <label for="tanggal">Tanggal</label>
                                <input type="date" class="form-control" name="tanggal" id="editTanggal"
                                    placeholder="Masukan Tanggal">
                            </div>
                            <div class="form-group col-6">
                                <label for="urlTarget">URL Target</label>
                                <input type="text" class="form-control" name="url_target" id="edittUrl"
                                    placeholder="Masukan Url Target">
                            </div>
                            <div class="form-group col-6">
                                <label for="namaInstansi">Nama Instansi/Dinas</label>
                                <select class="form-control" name="nama_in" id="editDinas">
                                    <option selected disabled>-- Pilih Instansi/Dinas --</option>

                                    <?php foreach ($dataDinas as $v) : ?>
                                    <option value="<?= $v['id_dinas'] ?>">
                                        <?= $v['nm_dinas'] ?>
                                    </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>


                            <div class="form-group col-6">
                                <label for="penanggungJawab">Penanggung Jawab</label>
                                <table class="col-md">
                                    <tr>
                                        <td><input type="text" class="form-control" name="p_jawab" id="editPjawab"
                                                placeholder="Nama">
                                        </td>
                                        <td><input type="email" class="form-control" name="p_email" id="editPemail"
                                                placeholder="Email">
                                        </td>
                                        <td><input type="number" class="form-control" name="p_no" id="editPkontak"
                                                placeholder="No.Kontak"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="form-group col-6">
                                <label for="exampleInputIPAddress">IP Address</label>
                                <input type="text" class="form-control" name="ip_addres" id="ieditpAddress"
                                    placeholder="Masukan IP Address">
                            </div>
                            <div class="form-group col-6">
                                <label for="sthosting">Status Hosting</label>
                                <select name="status_hg" id="editStatusHosting" class="form-control">
                                    <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                    <option value="Permanen">Permanen</option>
                                    <option value="Temporary">Temporary</option>
                                </select>
                            </div>
                            <div class="form-group col-6">
                                <label for="exampleInputEmail1">Hasil Pentest</label>
                                <table class="col-md">
                                    <tr>
                                        <td><input type="number" class="form-control" name="h_high" id="editHigh"
                                                placeholder="High">
                                        </td>
                                        <td><input type="number" class="form-control" name="h_med" id="editMedium"
                                                placeholder="Medium">
                                        </td>
                                        <td><input type="number" class="form-control" name="h_low" id="editLow"
                                                placeholder="Low">
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="form-group col-6">
                                <label for="namaInstansi">Keterangan</label>
                                <select name="ket" id="editKeterangan" class="form-control" placeholder="masukan nama">
                                    <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                    <option value="Berhasil">Berhasil</option>
                                    <option value="Bagus">Bagus</option>
                                    <option value="OK">OK</option>
                                    <option value="Pentest Ulang">Pentest Ulang</option>
                                    <option value="Tidak Dapat Diakses">Tidak Dapat Diakses</option>
                                </select>
                            </div>
                            <div class="form-group col-6">
                                <label for="editPdf">Upload File PDF</label>
                                <input type="file" class="form-control" name="file_pdf">
                                <small id="editPDFLabel" class="text-muted "></small>

                            </div>
                        </div>

                        <div class="modal-footer">
                            <!-- Tombol Tutup -->
                            <button type="button" class="btn btn-secondary" onclick="resetForm()"
                                data-dismiss="modal">Tutup</button>
                            <!-- Tombol Simpan (dalam bentuk submit form) -->
                            <button type="submit" class="btn btn-primary" onclick="tombolUpdate(event)">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Data -->
    <div class="modal fade" id="modalCreate" data-backdrop="static" tabindex="-1" role="dialog"
        aria-labelledby="modalCreateLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title" id="modalCreateLabel">Tambah Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="errorAlert" class="alert alert-danger d-none"></div>
                    <div id="successAlert" class="alert alert-success d-none"></div>
                    <!-- Formulir pengeditan data -->
                    <form method="post" id="formCreate" enctype="multipart/form-data"
                        action="<?= base_url('tabelpentest/create') ?>" onsubmit="tombolCreate(event)">
                        <input type="hidden" name="id" id="createId">

                        <!-- Tambahkan input sesuai dengan field yang ada pada data -->
                        <div class="row">
                            <div class="form-group col-6">
                                <label for="idPentest">Id Pentest</label>
                                <input type="text" class="form-control" name="kd_pentest" id="createIdPentest"
                                    placeholder="Masukan Id Pentest">
                            </div>
                            <div class="form-group col-6">
                                <label for="pemohon">Pemohon</label>
                                <input type="text" class="form-control" name="pemohon" id="createPemohon"
                                    placeholder="Nama Pemohon">
                            </div>
                            <div class="form-group col-6">
                                <label for="tanggal">Tanggal</label>
                                <input type="date" class="form-control" name="tanggal" id="createTanggal"
                                    placeholder="Masukan Tanggal">
                            </div>
                            <div class="form-group col-6">
                                <label for="urlTarget">URL Target</label>
                                <input type="text" class="form-control" name="url_target" id="createtUrl"
                                    placeholder="Masukan Url Target">
                            </div>
                            <div class="form-group col-6">
                                <label for="namaInstansi">Nama Instansi/Dinas</label>
                                <select class="form-control" name="nama_in" id="createDinas">
                                    <option selected disabled>-- Pilih Instansi/Dinas --</option>

                                    <?php foreach ($dataDinas as $v) : ?>
                                    <option value="<?= $v['id_dinas'] ?>">
                                        <?= $v['nm_dinas'] ?>
                                    </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>


                            <div class="form-group col-6">
                                <label for="penanggungJawab">Penanggung Jawab</label>
                                <table class="col-md">
                                    <tr>
                                        <td><input type="text" class="form-control" name="p_jawab" id="createPjawab"
                                                placeholder="Nama">
                                        </td>
                                        <td><input type="email" class="form-control" name="p_email" id="createPemail"
                                                placeholder="Email">
                                        </td>
                                        <td><input type="number" class="form-control" name="p_no" id="createPkontak"
                                                placeholder="No.Kontak"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="form-group col-6">
                                <label for="exampleInputIPAddress">IP Address</label>
                                <input type="text" class="form-control" name="ip_addres" id="createpAddress"
                                    placeholder="Masukan IP Address">
                            </div>
                            <div class="form-group col-6">
                                <label for="sthosting">Status Hosting</label>
                                <select name="status_hg" id="createStatusHosting" class="form-control">
                                    <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                    <option value="Permanen">Permanen</option>
                                    <option value="Temporary">Temporary</option>
                                </select>
                            </div>
                            <div class="form-group col-6">
                                <label for="exampleInputEmail1">Hasil Pentest</label>
                                <table class="col-md">
                                    <tr>
                                        <td><input type="number" class="form-control" name="h_high" id="createHigh"
                                                placeholder="High">
                                        </td>
                                        <td><input type="number" class="form-control" name="h_med" id="createMedium"
                                                placeholder="Medium">
                                        </td>
                                        <td><input type="number" class="form-control" name="h_low" id="createLow"
                                                placeholder="Low">
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="form-group col-6">
                                <label for="namaInstansi">Keterangan</label>
                                <select name="ket" id="createKeterangan" class="form-control"
                                    placeholder="masukan nama">
                                    <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                    <option value="Berhasil">Berhasil</option>
                                    <option value="Bagus">Bagus</option>
                                    <option value="OK">OK</option>
                                    <option value="Pentest Ulang">Pentest Ulang</option>
                                    <option value="Tidak Dapat Diakses">Tidak Dapat Diakses</option>
                                </select>
                            </div>
                            <div class="form-group col-6">
                                <label for="createPdf">Upload File PDF</label>
                                <input type="file" class="form-control" name="file_pdf">
                                <small id="editPDFLabel" class="text-muted "></small>

                            </div>
                        </div>

                        <div class="modal-footer">
                            <!-- Tombol Tutup -->
                            <button type="button" class="btn btn-secondary" onclick="resetForm()"
                                data-dismiss="modal">Tutup</button>
                            <!-- Tombol Simpan (dalam bentuk submit form) -->
                            <button type="submit" class="btn btn-primary" onclick="tombolCreate(event)">Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h5 class="card-header bg-primary">Data Penetration Testing</h5>
        <div class="card-body">
            <!-- Tombol Katakunci -->
            <form action="" method="get">
                <div class="input-group py-3">
                    <input type="text" class="form-control" placeholder="Masukan Katakunci"
                        value="<?php echo $katakunci?>" name="katakunci" aria-label="Recipient's username"
                        aria-describedby="button-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-info" type="submit" id="cari">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-info mb-3" data-toggle="modal" data-target="#modalCreate">
                <i class="fa fa-plus"></i> Tambah Data Pentest
            </button>

            <!-- Tabel Data -->
            <table id="example1" class="table table-striped table-bordered table-responsive">
                <thead class="text-center bg-secondary">
                    <tr class="">
                        <th rowspan="2">Id User</th>
                        <th rowspan="2">Pemohon</th>
                        <th rowspan="2">Tanggal</th>
                        <th rowspan="2">URL Target</th>
                        <th rowspan="2">Nama Instansi</th>
                        <th colspan="3">Penanggung Jawab</th>
                        <th rowspan="2">IP Address</th>
                        <th rowspan="2">Status Hosting</th>
                        <th colspan="3">Hasil Pentest</th>
                        <th rowspan="2">Keterangan</th>
                        <th rowspan="2">Upload File</th>
                        <th rowspan="2">View PDF</th>
                        <th rowspan="2">Aksi</th>


                    </tr>
                    <tr>
                        <th>Nama</th>
                        <th>Email</th>
                        <th>Kontak</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Low</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    foreach($dataPentest as $k => $v) { 
                        $nomor = $nomor + 1;
                    ?>
                    <tr>
                        <td><?php echo $v ['kd_pentest'] ?></td>
                        <td><?php echo $v ['pemohon'] ?></td>
                        <td><?php echo $v ['tanggal'] ?></td>
                        <td><?php echo $v ['url_target'] ?></td>

                        <td>
                            <?php foreach ($dataDinas as $dinas): ?>
                            <?php if ($dinas['id_dinas'] == $v['nama_in']): ?>
                            <?php echo $dinas['nm_dinas']; ?>
                            <?php break; ?>
                            <?php endif; ?>
                            <?php endforeach; ?>
                        </td>

                        <td><?php echo $v ['p_jawab'] ?></td>
                        <td><?php echo $v ['p_email'] ?></td>
                        <td><?php echo $v ['p_no'] ?></td>
                        <td><?php echo $v ['ip_addres'] ?></td>
                        <td><?php echo $v ['status_hg'] ?></td>
                        <td><?php echo $v ['h_high'] ?></td>
                        <td><?php echo $v ['h_med'] ?></td>
                        <td><?php echo $v ['h_low'] ?></td>
                        <td><?php echo $v ['ket'] ?></td>
                        <td><?php echo $v ['file_pdf']?></td>

                        <!-- Di dalam loop -->
                        <td class="text-center">
                            <button type="button" class="btn btn-primary btn-sm"
                                onclick="tombolLihatPDF(<?= $v['kd_pentest'] ?>)">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                        </td>
                        <td>
                            <div class="d-flex">
                                <button type="button" class="btn btn-warning btn-sm mx-2" data-toggle="modal"
                                    data-target="#modalEdit" onclick="edit(<?php echo $v['id'] ?>)"><i
                                        class="fa fa-pen"></i>
                                </button>

                                <button type="button" class="btn btn-danger btn-sm mx-2" data-toggle="modal"
                                    data-target="#hapusModal" <?= $v['id'] ?>"><i class=" fa fa-trash"></i>
                                </button>

                            </div>
                        </td>
                    </tr>
                    <?php } ?>
                </tbody>
            </table>
            <br>
            <?php
                $linkPagination = $pager->links();
                $linkPagination = str_replace('<li class="active">','<li class="page-item active">',$linkPagination);
                $linkPagination = str_replace('<li>','<li class="page-item">', $linkPagination);
                $linkPagination = str_replace("<a","<a class='page-link'",$linkPagination);
                echo $linkPagination;
            ?>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
</script>

<script>
function edit($id) {
    $.ajax({
        url: "<?php echo site_url("tabelpentest/edit") ?>/" + $id,
        type: "get",
        success: function(hasil) {
            var $obj = $.parseJSON(hasil);
            if ($obj.id != '') {
                $('#editId').val($obj.id);
                $('#editIdPentest').val($obj.kd_pentest);
                $('#editPemohon').val($obj.pemohon);
                $('#editTanggal').val($obj.tanggal);
                $('#editUrl').val($obj.url_target);
                $('#editDinas').val($obj.nama_in);
                $('#editPjawab').val($obj.p_jawab);
                $('#editPemail').val($obj.p_email);
                $('#editPkontak').val($obj.p_no);
                $('#editIpAddress').val($obj.ip_addres);
                $('#editStatusHosting').val($obj.status_hg);
                $('#editHigh').val($obj.h_high);
                $('#editMedium').val($obj.h_med);
                $('#editLow').val($obj.h_low);
                $('#editKeterangan').val($obj.ket);
                var pdfFileName = $obj.file_pdf;
                $('#editPDFLabel').text('File PDF : ' + pdfFileName);
            }
        }
    });
}

function tombolUpdate(event) {

    event.preventDefault(); // Mencegah aksi klik default

    $('#tombolUpdate').prop('disabled', true); // Menonaktifkan tombol

    var formData = new FormData($('#editForm')[0]);

    $.ajax({
        type: 'POST',
        url: $('#editForm').attr('action'),
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.status === 'success') {
                // Tampilkan alert sukses dengan animasi fadeIn
                $('#successAlert').removeClass('d-none show hide').html('<strong>Sukses!</strong> ' +
                    response.message);
                $('#errorAlert').addClass('d-none hide'); // Sembunyikan alert error

                // Tambahkan kelas 'show' untuk memulai animasi
                setTimeout(function() {
                    $('#successAlert').addClass('show');
                }, 10);

                // Sembunyikan alert sukses setelah 3 detik
                setTimeout(function() {
                    $('#successAlert').removeClass('show').addClass('hide');
                    location.reload(); // Reload halaman setelah alert sukses disembunyikan
                }, );
            } else {
                // Tampilkan alert error di dalam modal
                $('#errorAlert').removeClass('d-none show hide').html('<strong>Error!</strong> ' + response
                    .message);

                // Tampilkan pesan validasi error di atas alert error
                if (response.error_messages) {
                    var errorMessageHtml = '<ul>';
                    $.each(response.error_messages, function(index, value) {
                        errorMessageHtml += '<li>' + value + '</li>';
                    });
                    errorMessageHtml += '</ul>';
                    $('#errorAlert').append(errorMessageHtml);
                }

                // Tambahkan kelas 'show' untuk memulai animasi
                setTimeout(function() {
                    $('#errorAlert').addClass('show');
                }, 10);
            }
        },
        error: function(xhr, status, error) {
            console.error(xhr.responseText);
        },
        complete: function() {
            $('#tombolUpdate').prop('disabled',
                false); // Mengaktifkan kembali tombol setelah permintaan selesai
        }
    });
}

function tombolCreate(event) {

    event.preventDefault(); // Mencegah aksi klik default

    $('#tombolCreate').prop('disabled', true); // Menonaktifkan tombol

    var formData = new FormData($('#createForm')[0]);

    $.ajax({
        type: 'POST',
        url: $('#createForm').attr('action'),
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.status === 'success') {
                // Tampilkan alert sukses dengan animasi fadeIn
                $('#successAlert').removeClass('d-none show hide').html('<strong>Sukses!</strong> ' +
                    response.message);
                $('#errorAlert').addClass('d-none hide'); // Sembunyikan alert error

                // Tambahkan kelas 'show' untuk memulai animasi
                setTimeout(function() {
                    $('#successAlert').addClass('show');
                }, 10);

                // Sembunyikan alert sukses setelah 3 detik
                setTimeout(function() {
                    $('#successAlert').removeClass('show').addClass('hide');
                    location.reload(); // Reload halaman setelah alert sukses disembunyikan
                }, );
            } else {
                // Tampilkan alert error di dalam modal
                $('#errorAlert').removeClass('d-none show hide').html('<strong>Error!</strong> ' + response
                    .message);

                // Tampilkan pesan validasi error di atas alert error
                if (response.error_messages) {
                    var errorMessageHtml = '<ul>';
                    $.each(response.error_messages, function(index, value) {
                        errorMessageHtml += '<li>' + value + '</li>';
                    });
                    errorMessageHtml += '</ul>';
                    $('#errorAlert').append(errorMessageHtml);
                }

                // Tambahkan kelas 'show' untuk memulai animasi
                setTimeout(function() {
                    $('#errorAlert').addClass('show');
                }, 10);
            }
        },
        error: function(xhr, status, error) {
            console.error(xhr.responseText);
        },
        complete: function() {
            $('#tomboCreate').prop('disabled',
                false); // Mengaktifkan kembali tombol setelah permintaan selesai
        }
    });
}

function resetForm() {
    // Reset nilai formulir ke nilai awal
    $('#formCreate')[0].reset();
    $('#editForm')[0].reset();

    // Sembunyikan alert error dan sukses
    $('#errorAlert').addClass('d-none hide');
    $('#successAlert').addClass('d-none hide');
}
</script>