<div class="content-header">
    <div class="container-fluid">
        <h1>Data User Aplikasi Notepent</h1>
    </div>
</div>

<div class="container-fluid px-4">

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-backdrop="static" tabindex="-1" role="dialog"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h5 class="modal-title" id="staticBackdropLabel">Form Data Pentest</h5>
                    <button type="button" class="close tombol-tutup" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <!-- Form Input Data -->
                    <?=form_open_multipart('tabelpentest/simpan', 'id="formPentest"');?>
                    enctype="multipart/form-data" id="formPentest">
                    <input type="hidden" id="inputId">
                    <div class="row">
                        <div class="form-group col-6">
                            <label for="idPentest">Id Pentest</label>
                            <input type="text" class="form-control" id="inputIdPentest"
                                placeholder="Masukan Id Pentest">
                        </div>
                        <div class="form-group col-6">
                            <label for="pemohon">Pemohon</label>
                            <input type="text" class="form-control" id="inputPemohon" placeholder="Nama Pemohon">
                        </div>
                        <div class="form-group col-6">
                            <label for="tanggal">Tanggal</label>
                            <input type="date" class="form-control" id="inputTanggal" placeholder="Masukan Tanggal">
                        </div>
                        <div class="form-group col-6">
                            <label for="urlTarget">URL Target</label>
                            <input type="text" class="form-control" id="inputUrl" placeholder="Masukan Url Target">
                        </div>
                        <div class="form-group col-6">
                            <label for="namaInstansi">Nama Instansi/Dinas</label>
                            <select class="form-control" id="inputDinas">
                                <option value="-- Pilih Instansi/Dinas --" selected="-- Pilih Instansi/Dinas --">--
                                    Pilih Instansi/Dinas --</option>
                                <?php foreach ($dataDinas as $v) : ?>
                                <option value="<?= $v['id_dinas'] ?>"> <?= $v['nm_dinas'] ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="form-group col-6">
                            <label for="penanggungJawab">Penanggung Jawab</label>
                            <table class="col-md">
                                <tr>
                                    <td><input type="text" class="form-control" id="inputPjawab" placeholder="Nama">
                                    </td>
                                    <td><input type="email" class="form-control" id="inputPemail" placeholder="Email">
                                    </td>
                                    <td><input type="number" class="form-control" id="inputPkontak"
                                            placeholder="No.Kontak"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="form-group col-6">
                            <label for="exampleInputIPAddress">IP Address</label>
                            <input type="text" class="form-control" id="inputIpAddress"
                                placeholder="Masukan IP Address">
                        </div>
                        <div class="form-group col-6">
                            <label for="sthosting">Status Hosting</label>
                            <select id="inputStatusHosting" class="form-control">
                                <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                <option value="Permanen">Permanen</option>
                                <option value="Temporary">Temporary</option>
                            </select>
                        </div>
                        <div class="form-group col-6">
                            <label for="exampleInputEmail1">Hasil Pentest</label>
                            <table class="col-md">
                                <tr>
                                    <td><input type="number" class="form-control" id="inputHigh" placeholder="High">
                                    </td>
                                    <td><input type="number" class="form-control" id="inputMedium" placeholder="Medium">
                                    </td>
                                    <td><input type="number" class="form-control" id="inputLow" placeholder="Low">
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="form-group col-6">
                            <label for="namaInstansi">Keterangan</label>
                            <select id="inputKeterangan" class="form-control" placeholder="masukan nama">
                                <option selected="--Pilih Keterangan--">--Pilih Keterangan--</option>
                                <option value="Berhasil">Berhasil</option>
                                <option value="Bagus">Bagus</option>
                                <option value="OK">OK</option>
                                <option value="Pentest Ulang">Pentest Ulang</option>
                                <option value="Tidak Dapat Diakses">Tidak Dapat Diakses</option>
                            </select>
                        </div>
                        <div class="form-group col-6">
                            <label for="inputPdf">Upload File PDF</label>
                            <input type="file" class="form-control" name="file_pdf" id="file_pdf" accept=".pdf"
                                required>
                            <small class="text-muted">Upload file PDF maksimal 1MB</small>
                        </div>

                    </div>

                    <?= form_close(); ?>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary tombol-tutup" data-dismiss="modal">Tutup</button>
                    <button type="submit" class="btn btn-primary" id="tombolSimpan">Simpan</button>
                </div>

            </div>
        </div>
    </div>
    <div class="card">
        <h5 class="card-header bg-danger">Data Pentest</h5>
        <div class="card-body">
            <!-- Tombol Katakunci -->
            <form action="" method="get">
                <div class="input-group py-3">
                    <input type="text" class="form-control" placeholder="Masukan Katakunci"
                        value="<?php echo $katakunci?>" name="katakunci" aria-label="Recipient's username"
                        aria-describedby="button-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit" id="cari">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#staticBackdrop">
                <i class="fa fa-plus"></i> Tambah Data User
            </button>

            <!-- Tabel Data -->
            <table id="example1" class="table table-striped table-bordered table-responsive">
                <thead class="text-center bg-secondary">
                    <tr class="">
                        <th rowspan="2">Id User</th>
                        <th rowspan="2">Pemohon</th>
                        <th rowspan="2">Tanggal</th>
                        <th rowspan="2">URL Target</th>
                        <th rowspan="2">Nama Instansi</th>
                        <th colspan="3">Penanggung Jawab</th>
                        <th rowspan="2">IP Address</th>
                        <th rowspan="2">Status Hosting</th>
                        <th colspan="3">Hasil Pentest</th>
                        <th rowspan="2">Keterangan</th>
                        <th rowspan="2">Upload File</th>
                        <th rowspan="2">View PDF</th>
                        <th rowspan="2">Aksi</th>


                    </tr>
                    <tr>
                        <th>Nama</th>
                        <th>Email</th>
                        <th>Kontak</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Low</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    foreach($dataPentest as $k => $v) { 
                        $nomor = $nomor + 1;
                    ?>
                    <tr>
                        <td><?php echo $v ['id_pentest'] ?></td>
                        <td><?php echo $v ['pemohon'] ?></td>
                        <td><?php echo $v ['tanggal'] ?></td>
                        <td><?php echo $v ['url_target'] ?></td>
                        <td><?php echo $v ['nama_in'] ?></td>
                        <td><?php echo $v ['p_jawab'] ?></td>
                        <td><?php echo $v ['p_email'] ?></td>
                        <td><?php echo $v ['p_no'] ?></td>
                        <td><?php echo $v ['ip_addres'] ?></td>
                        <td><?php echo $v ['status_hg'] ?></td>
                        <td><?php echo $v ['h_high'] ?></td>
                        <td><?php echo $v ['h_med'] ?></td>
                        <td><?php echo $v ['h_low'] ?></td>
                        <td><?php echo $v ['ket'] ?></td>

                        <td><?php echo $v ['file_pdf']?></td>

                        <td class="text-center">
                            <a href="<?= base_url('tabelpentest/lihat_pdf/' . $v['id_pentest']) ?>" target="_blank"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </td>
                        <td>
                            <div class="d-flex">
                                <button type="button" class="btn btn-warning btn-sm mx-2" data-toggle="modal"
                                    data-target="#staticBackdrop" onclick="edit(<?php echo $v['id'] ?>)"><i
                                        class="fa fa-pen"></i>
                                </button>

                                <button type="button" class="btn btn-danger btn-sm mx-2"
                                    onclick="hapus(<?php echo $v['id'] ?>)"><i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>

                    </tr>
                    <?php } ?>
                </tbody>
            </table>
            <br>
            <?php
                $linkPagination = $pager->links();
                $linkPagination = str_replace('<li class="active">','<li class="page-item active">',$linkPagination);
                $linkPagination = str_replace('<li>','<li class="page-item">', $linkPagination);
                $linkPagination = str_replace("<a","<a class='page-link'",$linkPagination);
                echo $linkPagination;
            ?>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
</script>

<script>
function hapus($id) {
    var result = confirm('Yakin ingin menghapus data');
    if (result) {
        window.location = "<?php echo site_url("tabelpentest/hapus")?>/" + $id;

    }
}

function edit($id) {
    $.ajax({
        url: "<?php echo site_url("tabelpentest/edit") ?>/" + $id,
        type: "get",
        success: function(hasil) {
            var $obj = $.parseJSON(hasil);
            if ($obj.id != '') {
                $('#inputId').val($obj.id);
                $('#inputIdPentest').val($obj.id_pentest);
                $('#inputPemohon').val($obj.pemohon);
                $('#inputTanggal').val($obj.tanggal);
                $('#inputUrl').val($obj.url_target);
                $('#inputDinas').val($obj.nama_in);
                $('#inputPjawab').val($obj.p_jawab);
                $('#inputPemail').val($obj.p_email);
                $('#inputPkontak').val($obj.p_no);
                $('#inputIpAddress').val($obj.ip_addres);
                $('#inputStatusHosting').val($obj.status_hg);
                $('#inputHigh').val($obj.h_high);
                $('#inputMedium').val($obj.h_med);
                $('#inputLow').val($obj.h_low);
                $('#inputKeterangan').val($obj.ket);
                $('#inputPDF').val($obj.file_name);

            }
        }
    });
}

function bersihkan() {
    $('#inputId').val('');
    $('#inputIdPentest').val('');
    $('#inputPemohon').val('');
    $('#inputTanggal').val('');
    $('#inputUrl').val('');
    $('#inputDinas').val('');
    $('#inputPjawab').val('');
    $('#inputPemail').val('');
    $('#inputPkontak').val('');
    $('#inputIpAddress').val('');
    $('#inputStatusHosting').val('');
    $('#inputHigh').val('');
    $('#inputMedium').val('');
    $('#inputLow').val('');
    $('#inputKeterangan').val('');
    $('#inputPDF').val('');
}
$('.tombol-tutup').on('click', function() {
    if ($('.sukses').is(":visible")) {
        window.location.href = "<?php echo current_url()."?".$_SERVER['QUERY_STRING']?>";
    }
    bersihkan();
});

$('#tombolSimpan').on('click', function() {
    var $id = $('#inputId').val();
    var $id_pentest = $('#inputIdPentest').val();
    var $pemohon = $('#inputPemohon').val();
    var $tanggal = $('#inputTanggal').val();
    var $url_target = $('#inputUrl').val();
    var $nama_in = $('#inputDinas').val();
    var $p_jawab = $('#inputPjawab').val();
    var $p_email = $('#inputPemail').val();
    var $p_no = $('#inputPkontak').val();
    var $ip_addres = $('#inputIpAddress').val();
    var $status_hg = $('#inputStatusHosting').val();
    var $h_high = $('#inputHigh').val();
    var $h_med = $('#inputMedium').val();
    var $h_low = $('#inputLow').val();
    var $ket = $('#inputKeterangan').val();


    $.ajax({
        url: "<?php echo site_url('tabelpentest/simpan') ?>",
        type: "POST",
        data: {
            id: $id,
            id_pentest: $id_pentest,
            pemohon: $pemohon,
            tanggal: $tanggal,
            url_target: $url_target,
            nama_in: $nama_in,
            p_jawab: $p_jawab,
            p_email: $p_email,
            p_no: $p_no,
            ip_addres: $ip_addres,
            status_hg: $status_hg,
            h_high: $h_high,
            h_med: $h_med,
            h_low: $h_low,
            ket: $ket,
            file_pdf: $file_pdf

        },
        success: function(hasil) {
            var $obj = $.parseJSON(hasil);
            if ($obj.sukses == false) {
                $('.sukses').hide();
                $('.error').show();
                $('.error').html($obj.error);

            } else {
                $('.error').hide();
                $('.sukses').show();
                $('.sukses').html($obj.sukses);
            }
        }
    });
    bersihkan();
});
</script>